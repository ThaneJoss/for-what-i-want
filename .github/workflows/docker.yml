# .github/workflows/image-sync.yml

# å·¥ä½œæµåç§°ï¼šé•œåƒåŒæ­¥å¤„ç†å™¨
# åŠŸèƒ½ï¼šè‡ªåŠ¨æ‹‰å–ã€æ ‡è®°å¹¶æ¨é€åˆ°ç§æœ‰ä»“åº“ï¼Œç„¶åå½’æ¡£ä»»åŠ¡è®°å½•ã€‚
name: é•œåƒåŒæ­¥å¤„ç†å™¨

# è§¦å‘æ¡ä»¶ï¼šå½“ 'this is what i want/' ç›®å½•ä¸‹çš„å†…å®¹å‘ç”Ÿå˜åŒ–æ—¶ï¼Œåœ¨ main åˆ†æ”¯ä¸Šè§¦å‘
on:
  push:
    branches:
      - main

# å®šä¹‰ä»»åŠ¡
jobs:
  # ä»»åŠ¡IDï¼šprocess-sync-queue
  process-sync-queue:
    # ä»»åŠ¡æ˜¾ç¤ºåç§°
    name: å¤„ç†é•œåƒåŒæ­¥é˜Ÿåˆ—
    # è¿è¡Œç¯å¢ƒ
    runs-on: ubuntu-latest
    permissions:
      contents: write
    # ä»»åŠ¡æ­¥éª¤
    steps:
      # æ­¥éª¤ 1: æ£€å‡ºä»£ç 
      # ä½¿ç”¨ PAT (Personal Access Token) ä»¥ç¡®ä¿åç»­æœ‰æƒé™æ¨é€å˜æ›´å›ä»“åº“
      - name: â‘  æ£€å‡ºä»£ç ä»“åº“
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      # æ­¥éª¤ 2: ç™»å½•ç§æœ‰é•œåƒä»“åº“
      - name: â‘¡ ç™»å½•ç§æœ‰ Docker ä»“åº“
        uses: docker/login-action@v3
        with:
          registry: ${{ secrets.PRIVATE_REGISTRY }}
          username: ${{ secrets.PRIVATE_REGISTRY_USERNAME }}
          password: ${{ secrets.PRIVATE_REGISTRY_PASSWORD }}

      # æ–°å¢æ­¥éª¤: è®¾ç½® Python ç¯å¢ƒ
      - name: â‘¢ è®¾ç½® Python ç¯å¢ƒ
        uses: actions/setup-python@v5

      # æ­¥éª¤ 4: æ ¸å¿ƒå¤„ç†é€»è¾‘ (ç°åœ¨è°ƒç”¨ Python è„šæœ¬)
      - name: â‘£ æ‰§è¡Œé•œåƒåŒæ­¥è„šæœ¬
        id: sync # ä¸ºæ­¤æ­¥éª¤è®¾ç½®IDï¼Œæ–¹ä¾¿åç»­æ­¥éª¤å¼•ç”¨å…¶è¾“å‡º
        env:
          # é€šè¿‡ç¯å¢ƒå˜é‡å°†é…ç½®å’Œå¯†é’¥ä¼ é€’ç»™ Python è„šæœ¬
          SOURCE_DIR: "this is what i want"
          OUTPUT_DIR: "got it"
          PRIVATE_REGISTRY: ${{ secrets.PRIVATE_REGISTRY }}
          PRIVATE_REGISTRY_NAMESPACE: ${{ secrets.PRIVATE_REGISTRY_NAMESPACE }}

        run: python .github/scripts/main.py

      # æ­¥éª¤ 5: æäº¤å˜æ›´
      # é€»è¾‘ä¸å˜ï¼Œä»…å½“ä¸Šä¸€æ­¥ï¼ˆid: syncï¼‰ç¡®å®å¤„ç†äº†æ–‡ä»¶æ—¶æ‰è¿è¡Œ
      - name: â‘¤ æäº¤å¤„ç†ç»“æœ
        if: steps.sync.outputs.has_processed_files == 'true'
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'

          git add 'got it/' 'this is what i want/'

          # æ£€æŸ¥æ˜¯å¦å­˜åœ¨æš‚å­˜çš„å˜æ›´ï¼Œé¿å…åˆ›å»ºç©ºæäº¤
          if ! git diff --staged --quiet; then
            git commit -m "ğŸ¤–ï¼šæˆåŠŸè½¬å‘é•œåƒ"
            git push
            echo "ğŸ‰ å˜æ›´å·²æˆåŠŸæäº¤å›ä»“åº“ï¼"
          else
            echo "â„¹ï¸ æ— å˜æ›´éœ€è¦æäº¤ã€‚"
          fi
